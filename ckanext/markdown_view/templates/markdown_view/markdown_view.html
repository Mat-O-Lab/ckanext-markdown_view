<link rel="stylesheet" href="/markdown_view.css" />
<div id="markdown_content"></div>

<!-- KaTeX CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.15/dist/katex.min.css"
    integrity="sha384-Htz9HMhiwV8GuQ28Xr9pEs1B4qJiYu/nYLLwlDklR53QibDfmQzi7rYxXhMH/5/u" crossorigin="anonymous">

<!-- KaTeX JS -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.15/dist/katex.min.js"
    integrity="sha384-bxmi2jLGCvnsEqMuYLKE/KsVCxV3PqmKeK6Y6+lmNXBry6+luFkEOsmp5vD9I/7+"
    crossorigin="anonymous"></script>

<!-- Auto-render extension to automatically render math expressions -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.15/dist/contrib/auto-render.min.js"
    integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
    onload="renderMathInElement(document.getElementById('markdown_content'));"></script>

<!-- Marked.js and DOMPurify for rendering Markdown -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.5/purify.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js" crossorigin="anonymous"></script>

<script>
    const renderer = {
        // Use the default code block rendering for Markdown
        code(code, lang) {
            return `<pre><code>${code}</code></pre>`;
        },
        // For inline math, marked.js will use this codespan method (but `auto-render` takes care of math rendering)
        codespan(text) {
            return `<code>${text}</code>`;
        }
    };

    // Integrating the custom renderer with marked.js
    marked.use({ renderer });

    // Fetching and rendering the Markdown content
    fetch("{{ resource_view.get('page_url') or resource.get('url') }}")  // Path to raw Markdown file
        .then(response => response.text())  // Convert to text
        .then(markdown => {
            // Parsing the Markdown text into HTML
            let parsedHTML = marked.parse(markdown.replace(/^[\u200B\u200C\u200D\u200E\u200F\uFEFF]/, ""));

            // Sanitize the generated HTML content
            parsedHTML = DOMPurify.sanitize(parsedHTML);

            // Inject sanitized HTML into the page
            const contentDiv = document.getElementById("markdown_content");
            contentDiv.innerHTML = parsedHTML;

            // Trigger KaTeX rendering for math expressions inside the markdown_content div
            renderMathInElement(contentDiv, {
                delimiters: [
                    { left: "$$", right: "$$", display: true }, // Block math
                    { left: "$", right: "$", display: false }   // Inline math
                ],
                throwOnError: false
            });
        })
        .catch(error => console.error("Failed to load Markdown content:", error));
</script>