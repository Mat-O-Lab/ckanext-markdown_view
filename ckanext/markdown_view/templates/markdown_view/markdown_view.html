<!-- KaTeX CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" crossorigin="anonymous" />

<!-- Markdown CSS -->
<link rel="stylesheet" href="/markdown_view.css" />

<div id="markdown_content"></div>

<!-- Required Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.5/purify.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" crossorigin="anonymous"></script>

<script>
    // Function to process LaTeX expressions
    function mathsExpression(expr) {
        try {
            // Block equations: $$ ... $$
            if (expr.match(/^\$\$[\s\S]*\$\$$/)) {
                expr = expr.substr(2, expr.length - 4); // Remove $$ delimiters
                return katex.renderToString(expr, { displayMode: true });
            }
            // Inline equations: $ ... $
            else if (expr.match(/^\$[\s\S]*\$$/)) {
                expr = expr.substr(1, expr.length - 2); // Remove $ delimiters
                return katex.renderToString(expr, { displayMode: false });
            }
        } catch (e) {
            console.error("KaTeX render error:", e);
            return expr; // Fallback to plain text if rendering fails
        }
    }

    // Custom Renderer for Marked
    const renderer = {
        // Handle code blocks for LaTeX math
        code(code, lang, escaped) {
            if (!lang) { // No language specified, check for math
                const math = mathsExpression(code);
                if (math) {
                    return math; // Render as KaTeX
                }
            }
            // Use default behavior for other code blocks
            return false;
        },

        // Handle inline code spans for LaTeX math
        codespan(text) {
            const math = mathsExpression(text);
            if (math) {
                return math; // Render as KaTeX
            }
            // Use default behavior for other code spans
            return false;
        }
    };

    // Use the custom renderer with Marked
    marked.use({ renderer });

    // Fetch and Render Markdown Content
    fetch("{{ resource_view.get('page_url') or resource.get('url') }}")
        .then(response => response.text()) // Fetch raw text
        .then(markdown => {
            // Parse Markdown content with Marked
            const parsedHTML = marked.parse(markdown.replace(/^[\u200B\u200C\u200D\u200E\u200F\uFEFF]/, ""));

            // Sanitize content for security
            const sanitizedContent = DOMPurify.sanitize(parsedHTML);

            // Inject the sanitized HTML into the page
            document.getElementById("markdown_content").innerHTML = sanitizedContent;
        })
        .catch(error => console.error("Failed to load Markdown content:", error));
</script>